---
title: "Testing bad data"
author: "Torbj√∏rn Skinnemoen Ottersen"
date: '2022-07-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman"); library(pacman)
p_load(shiny,tidyverse, scales, rvest, janitor, plotly, readxl, MetBrewer)

```

## Functions and data
```{r}
read_proff8 <- function(file, start, end) {
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table() |>
    select( # removing empty column
      REGNSKAPSPERIODE:all_of(start)
    ) |> # using all_of()
    mutate( # removing whitespace
      REGNSKAPSPERIODE = str_squish(REGNSKAPSPERIODE)
    ) |>
    filter( # removing duplicate table - no idea why it's necessary
      !row_number() > 176
    ) |>
    filter( # removing duplicate rows
      !grepl("Lukk", REGNSKAPSPERIODE)
    ) |>
    pivot_longer( # tidying data
      all_of(end):all_of(start),
      names_to = "year"
    ) |> # using all_of()
    mutate( # changing to real NAs and turning years into numbers
      value = na_if(value, "-"),
      year = as.integer(year),
      valutakode = ifelse(REGNSKAPSPERIODE == "Valutakode", value, NA)
    ) |>
    fill( # filling the currency column
      valutakode,
      .direction = "updown"
    ) |>
    filter( # removing dates and redundant currency
      REGNSKAPSPERIODE != "Sluttdato" & REGNSKAPSPERIODE != "Startdato" &
        REGNSKAPSPERIODE != "Valutakode"
    ) |>
    mutate( # removing whitespace in numbers
      value = str_replace_all(value, "\\s", ""),
      value = as.numeric(value),
      value = ifelse(grepl("i hele 1000", REGNSKAPSPERIODE), NA, value)
    ) |>
    distinct() |> # removing any remaining duplicate rows
    pivot_wider( # pivoting
      names_from = REGNSKAPSPERIODE, values_from = value
    ) |>
    clean_names() |> # tidying names
    select(
      -lederlonn_i_hele_1000,
      -resultatregnskap_i_hele_1000,
      -balanseregnskap_i_hele_1000
    ) |> # removing headings
    rename( # making it clear what lonn refers to
      lederlonn = lonn
    ) |>
    # Creating new variables for plots
    mutate(
      annual_profit = ifelse(arsresultat >= 0, TRUE, FALSE),
      balance_positive = ifelse(sum_egenkapital_og_gjeld >= 0, TRUE, FALSE)
    ) |>
    arrange(desc(year)) # arranging by year
}

riksmaal <- read_proff8("Shiny/Test/Data/Riksmaal2011_21.html", "2011", "2021")

print(sum(riksmaal$lederlonn, na.rm = TRUE))

sum(is.na(riksmaal$lederlonn)) == nrow(riksmaal)
nrow(riksmaal)

sum(!is.na(riksmaal$lederlonn))

sum

if (sum(is.na(riksmaal$lederlonn)) == nrow(riksmaal)) {
  "yes"
} else {
  "no"
}

testplot <- if (sum(!is.na(riksmaal$lederlonn)) == 0 &
    sum(!is.na(riksmaal$leder_annen_godtgjorelse)) == 0) {
    ggplot() +
    geom_text(aes(0, 0, label = "No information available")) +
    theme_void()
} else {
  "yes"
}

ggplotly(testplot)

riksmaal$leder_annen_godtgjorelse

sum(!is.na(riksmaal$lederlonn)) == 0

riksmaal |> 
    ggplot() +
    annotate("No information available") +
    theme_void()

ggplot() +
    theme_void() +
    geom_text(aes(0,0,label='N/A')) +
    xlab(NULL)

ggplot() +
    geom_text(aes(0, 0, label = "No information available")) +
    theme_void()

ggplot() +
    geom_text(aes(0, 0, label = " ")) +
    theme_void() +
  annotate(
    "text", label = "No information available",
    x = 0, y = 0, size = 8, colour = met.brewer("Hokusai2", 1)
  )


widen_excel_bad <- function(file) {
  read_excel(file) |>
    unite( # uniting Category and Name to deal with multiple 'Other'
      entry, c(Category, Name),
      sep = "_"
    ) |>
    select(-`Sub-category`) |> # deleting Sub-category
    # pivoting
    pivot_wider(names_from = entry, values_from = Value) |>
    clean_names() |>  # cleaning names
    mutate(
      leder_annen_godtgjorelse = 1000
    )
}

widen_excel <- function(file) {
  read_excel(file) |>
    unite( # uniting Category and Name to deal with multiple 'Other'
      entry, c(Category, Name),
      sep = "_"
    ) |>
    select(-`Sub-category`, -Firm) |> # deleting Sub-category
    # pivoting
    pivot_wider(names_from = entry, values_from = Value) |>
    clean_names() # cleaning names
}
test <- widen_excel("Shiny/Test/Data/Bad_data.xlsx")

test
good <- widen_excel("Shiny/Test/Data/OPXfinans_final.xlsx")
good
testnumber <- NA
ifelse(testnumber >= 0, TRUE, FALSE)

is.character(testnumber)

?is.numeric

is.numeric(kreft_excel$assets_property_plant_equipment_and_intangible_assets)
is.numeric(c())

exceltest <- read_excel("Shiny/Test/Data/Bad_data.xlsx")

is.numeric()

if (mean(unlist(lapply(exceldata(), is.numeric))) != 0) {
  TRUE
} else {
  FALSE
}

is.numeric(NA)
is.character(NA)

class(good)
?if_any

?lapply
```

