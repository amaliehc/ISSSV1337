---
title: "Charity analysis"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme: lumen
runtime: shiny
---

```{r setup, include=FALSE}
# Loading packages using pacman to ensure they're all installed
if (!require("pacman")) install.packages("pacman")
library(pacman)
p_load(
  shiny, tidyverse, scales, rvest, janitor, plotly, readxl,
  flexdashboard, MetBrewer, fontawesome, htmltools
)
# Using fontawesome for more up-to-date fontawesome icons
htmltools::tagList(fontawesome::fa_html_dependency())

# Considering lumen or cerulean theme
```


Sidebar {.sidebar}
=======================================================================

### File upload

Please upload an html copy of annual accounts from [Proff.no](https://www.proff.no) and enter the start and end years from that table.

Then upload an Excel file in the set format.

Click 'Analyse' to analyse the data.

```{r sidebar}
# HTML
fileInput("html", label = "Upload html file", accept = ".html")

# Year inputs
numericInput("start", label = "Start", value = 2002)
numericInput("end", label = "End", value = 2021)

# Excel
fileInput("excel", "Upload Excel file", accept = ".xlsx")

# Button
actionButton("click", "Analyse")


```

Dashboard
=======================================================================

Row 
-----------------------------------------------------------------------

### KPI
```{r}
valueBoxOutput("KPI_box_admin")
```

### KPI 2
```{r}
valueBoxOutput("KPI_box_fundraising")
```

### KPI 3
```{r}
valueBoxOutput("KPI_box_OPX")
```

### KPI 4
```{r}
valueBoxOutput("KPI_box4")
```

### KPI 5
```{r}
valueBoxOutput("KPI_box5")
```

Row
-----------------------------------------------------------------------

### Annual result
```{r}
plotlyOutput("arsresultat_plotly")
```

### Balance
```{r}
plotlyOutput("balance_plotly")
```

Row 
-----------------------------------------------------------------------

### Expenses
```{r}
plotlyOutput("expenses_plotly")
```

Row 
-----------------------------------------------------------------------

### Transparency
```{r}
plotlyOutput("CEO_plotly")
```

Details
=======================================================================

Row 
-----------------------------------------------------------------------

### Information 1

The KPIs are based on the following calculations:

- **admin** is based on dividing - expenses_administrative / expenses_program_services *100
- **Fundraising ROI** - (revenue_private_contributions +
                 revenue_membership_fees - expenses_fundraising) /
              expenses_fundraising * 100
```{r}

```

Row 
-----------------------------------------------------------------------

### Information 2
```{r}

```



```{r shiny, include=FALSE}
# Shiny actions
observeEvent(input$click, { # wait for button click

  #---- Data frames --------------------------------------------------------------      
  # creating data frame from html file
  htmldata <- reactive({
    read_proff8(
      input$html$datapath,
      as.character(input$start), as.character(input$end)
    )
  })

  # Creating data frame from Excel file
  exceldata <- reactive({
    widen_excel(input$excel$datapath)
  })

  #---- Value Boxes --------------------------------------------------------------    

  # Creating KPI_admin value
  KPI_admin_num <- reactive({
    exceldata() |>
      # most recent year
      filter(year == max(year)) |>
      # Calculating the value as a percentage; removing all other
      transmute(
        KPI_admin = expenses_administrative / (expenses_program_services +
          expenses_administrative +
          expenses_fundraising +
          expenses_other) * 100
      ) |>
      # just want the single number
      pull()
  })

  # Creating Fundraising ROI value
  KPI_fundraising_num <- reactive({
    exceldata() |>
      # most recent year
      filter(year == max(year)) |>
      transmute(
        # Calculating the value as a percentage; removing all other
        KPI_fundraising_num =
          (revenue_private_contributions +
            revenue_membership_fees - expenses_fundraising) /
            expenses_fundraising * 100
      ) |>
      # just want the single number
      pull()
  })

  # Creating OPX KPI
  KPI_OPX_num <- reactive({
    exceldata() |>
      filter(year == max(year)) |>
      transmute(
        KPI_OPX = (revenue_private_contributions + revenue_investments +
          assets_cash_in_bank_and_cash_equivalents) /
          (liability_short_term_grants_payable +
            liability_revocable_endowments +
            liability_long_term_grants_payable) * 100
      ) |>
      pull()
  })

  # Creating the value box for administrative expenses
  output$KPI_box_admin <- renderValueBox({
    valueBox(
      value = KPI_to_string(KPI_admin_num()),
      caption = "Administration as a % of total expenses",
      color = met.brewer("Wissing", n = 1),
      icon = "fa-random"
    )
  })

  # Creating value box for fundraising ROI
  # Unsure about colour levels
  output$KPI_box_fundraising <- renderValueBox({
    valueBox(
      value = KPI_to_string(KPI_fundraising_num()),
      caption = "Fundraising ROI",

      # Colour depends on value
      color = if (KPI_fundraising_num() < 100) {
        "danger"
      } else if (KPI_fundraising_num() < 200) {
        "warning"
      } else {
        "success"
      },
      icon = "fas fa-donate"
    )
  })

  # KPI_OPX
  output$KPI_box_OPX <- renderValueBox({
    valueBox(
      value = str_c(format(KPI_OPX_num(), digits = 3), "%"),
      caption = "Liquid assets / obligations",
      color = ifelse(KPI_OPX_num() <= 100, "success", "danger"),
      icon = "fas fa-coffee"
    )
  })

  # Duplicate value boxes for testing

  output$KPI_box4 <- renderValueBox({
    valueBox(
      value = KPI_to_string(KPI_admin_num()),
      caption = "Administration as a % of total expenses",
      color = met.brewer("Wissing", n = 1),
      icon = "fa-random"
    )
  })

  output$KPI_box5 <- renderValueBox({
    valueBox(
      value = KPI_to_string(KPI_admin_num()),
      caption = "Administration as a % of total expenses",
      color = met.brewer("Wissing", n = 1),
      icon = "fa-random"
    )
  })


  #---- Plots --------------------------------------------------------------------    
  #----CEO compensation-----------------------------------------------------------
  CEO_plot <- reactive({
    htmldata() |>
      # preparing for pivoting
      select(
        year, lederlonn, leder_annen_godtgjorelse
      ) |>
      # Compensation in ordinary numbers
      mutate(
        lederlonn = lederlonn * 1000,
        leder_annen_godtgjorelse = leder_annen_godtgjorelse * 1000
      ) |>
      # renaming for the purposes of the plot
      rename(
        Year = year,
        Salary = lederlonn,
        `Other compensation` = leder_annen_godtgjorelse
      ) |>
      # pivoting to join the two values to use fill
      pivot_longer(c(Salary, `Other compensation`), names_to = "Compensation") |>
      ggplot(aes(Year, value, fill = Compensation)) +
      geom_col() +
      scale_y_continuous(
        # Checking for uniform currency code
        labels = ifelse(length(unique(htmldata()$valutakode)) == 1,
          # Using the currency code if uniform
          label_dollar(prefix = str_c(htmldata()$valutakode[1], " ")),
          # alternative prefix if multiple currencies in the data
          label_dollar(prefix = "? ")
        )
      ) +
      # pretty colours
      scale_fill_met_d("Troy") +
      labs(
        x = "", y = "Total compensation", title = "CEO compensation"
      )
  })

  # Creating plotly output
  output$CEO_plotly <- renderPlotly(
    ggplotly(CEO_plot()) |>
      layout(
        annotations =
          list(
            x = 1, y = -0.1, text = currency_caption(),
            showarrow = F, xref = "paper", yref = "paper",
            xanchor = "right", yanchor = "auto", xshift = 0, yshift = 0,
            font = list(size = 11)
          )
      )
  )

  #----Annual result---------------------------------------------
  arsresultat_plot <- reactive({
    htmldata() |>
      ggplot(aes(year, arsresultat, fill = annual_profit)) +
      geom_col() +
      currency_scale() +
      # slightly nicer colours + ensuring positive values are always green
      scale_fill_met_d("Tsimshian",
        direction =
          ifelse(mean(htmldata()$annual_profit,
            na.rm = TRUE
          ) == 1, -1, 1)
      ) +
      theme(legend.position = "none") +
      labs(
        x = "", y = "", title = "Annual result (in thousands)"
      )
  })

  output$arsresultat_plotly <- renderPlotly(
    ggplotly(arsresultat_plot()) |>
      layout(
        annotations =
          list(
            x = 1, y = -0.1, text = currency_caption(),
            showarrow = F, xref = "paper", yref = "paper",
            xanchor = "right", yanchor = "auto", xshift = 0, yshift = 0,
            font = list(size = 11)
          )
      )
  )
  #----Balance--------------------------------------------------------------------    
  balance_plot <- reactive({
    htmldata() |>
      ggplot(aes(year, sum_egenkapital_og_gjeld, fill = balance_positive)) +
      geom_col() +
      currency_scale() +
      # slightly nicer colours + ensuring positive values are always green
      scale_fill_met_d("Tsimshian",
        direction = ifelse(
          mean(htmldata()$balance_positive,
            na.rm = TRUE
          ) == 1, -1, 1
        )
      ) +
      theme(legend.position = "none") +
      labs(
        x = "", y = "", title = "Balance (in thousands)",
      )
  })

  output$balance_plotly <- renderPlotly(
    ggplotly(balance_plot()) |>
      layout(
        annotations =
          list(
            x = 1, y = -0.1, text = currency_caption(),
            showarrow = F, xref = "paper", yref = "paper",
            xanchor = "right", yanchor = "auto", xshift = 0, yshift = 0,
            font = list(size = 11)
          )
      )
  )

  #----Expenses---------------------------------------
  expenses_plot <- reactive({
    exceldata() |>
      transmute(
        Year = as.factor(year),
        Other = expenses_other,
        Administrative = expenses_administrative,
        Fundraising = expenses_fundraising,
        `Program services` = expenses_program_services
      ) |>
      pivot_longer(c(Other:`Program services`), names_to = "Expenses") |>
      mutate(
        Expenses = ordered(Expenses,
          levels =
            c(
              "Program services", "Administrative",
              "Fundraising", "Other"
            )
        )
      ) |>
      ggplot(aes(Year, value, fill = Expenses)) +
      geom_col() +
      coord_flip() +
      currency_scale() +
      scale_fill_met_d("Troy") +
      labs(x = "", y = "", title = "Expenses (in thousands)")
  })

  output$expenses_plotly <- renderPlotly(
    ggplotly(expenses_plot()) |>
      layout(
        annotations =
          list(
            x = 1, y = -0.1, text = currency_caption(),
            showarrow = F, xref = "paper", yref = "paper",
            xanchor = "right", yanchor = "auto", xshift = 0, yshift = 0,
            font = list(size = 11)
          )
      )
  )

  #----Reactive functions-------------------------------
  # Reactive function to check for currency and use currency code or ?
  currency_scale <- reactive({
    scale_y_continuous(
      # Checking for uniform currency code
      labels = ifelse(length(unique(htmldata()$valutakode)) == 1,
        # Using the currency code if uniform
        label_dollar(prefix = str_c(htmldata()$valutakode[1], " ")),
        # alternative prefix if multiple currencies in the data
        label_dollar(prefix = "? ")
      )
    )
  })

  # Reactive function to create currency caption
  currency_caption <- reactive({
    if (length(unique(htmldata()$valutakode)) == 1) {
      ""
    } else {
      "Note: not all values are denominated in the same currency"
    }
  })
})


```

```{r non-reactive functions, include=FALSE}
# Function to read html file
read_proff8 <- function(file, start, end) {
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table() |>
    select( # removing empty column
      REGNSKAPSPERIODE:all_of(start)
    ) |> # using all_of()
    mutate( # removing whitespace
      REGNSKAPSPERIODE = str_squish(REGNSKAPSPERIODE)
    ) |>
    filter( # removing duplicate table - no idea why it's necessary
      !row_number() > 176
    ) |>
    filter( # removing duplicate rows
      !grepl("Lukk", REGNSKAPSPERIODE)
    ) |>
    pivot_longer( # tidying data
      all_of(end):all_of(start),
      names_to = "year"
    ) |> # using all_of()
    mutate( # changing to real NAs and turning years into numbers
      value = na_if(value, "-"),
      year = as.integer(year),
      valutakode = ifelse(REGNSKAPSPERIODE == "Valutakode", value, NA)
    ) |>
    fill( # filling the currency column
      valutakode,
      .direction = "updown"
    ) |>
    filter( # removing dates and redundant currency
      REGNSKAPSPERIODE != "Sluttdato" & REGNSKAPSPERIODE != "Startdato" &
        REGNSKAPSPERIODE != "Valutakode"
    ) |>
    mutate( # removing whitespace in numbers
      value = str_replace_all(value, "\\s", ""),
      value = as.numeric(value),
      value = ifelse(grepl("i hele 1000", REGNSKAPSPERIODE), NA, value)
    ) |>
    distinct() |> # removing any remaining duplicate rows
    pivot_wider( # pivoting
      names_from = REGNSKAPSPERIODE, values_from = value
    ) |>
    clean_names() |> # tidying names
    select(
      -lederlonn_i_hele_1000,
      -resultatregnskap_i_hele_1000,
      -balanseregnskap_i_hele_1000
    ) |> # removing headings
    rename( # making it clear what lonn refers to
      lederlonn = lonn
    ) |>
    # Creating new variables for plots
    mutate(
      annual_profit = ifelse(arsresultat >= 0, TRUE, FALSE),
      balance_positive = ifelse(sum_egenkapital_og_gjeld >= 0, TRUE, FALSE)
    ) |>
    arrange(desc(year)) # arranging by year
}

# Function to read Excel file
widen_excel <- function(file) {
  read_excel(file) |>
    unite( # uniting Category and Name to deal with multiple 'Other'
      entry, c(Category, Name),
      sep = "_"
    ) |>
    select(-`Sub-category`) |> # deleting Sub-category
    # pivoting
    pivot_wider(names_from = entry, values_from = Value) |>
    clean_names() # cleaning names
}

# Function to turn KPI values into NA or percentage string
KPI_to_string <- function(variable){
  if (variable == 0 | is.na(variable)){
    NA
  } else {
    str_c(format(variable, digits = 3), "%")
  }
}


```

