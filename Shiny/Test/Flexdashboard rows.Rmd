---
title: "Charity analysis"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
runtime: shiny
---

```{r setup, include=FALSE}
# Loading packages using pacman to ensure they're all installed
if (!require("pacman")) install.packages("pacman"); library(pacman)
p_load(shiny, tidyverse, scales, rvest, janitor, plotly, readxl,
       flexdashboard, MetBrewer, fontawesome, htmltools)
# Using fontawesome for more up-to-date fontawesome icons
htmltools::tagList(fontawesome::fa_html_dependency())
```


Sidebar {.sidebar}
=======================================================================

### File upload

Please upload an html copy of annual accounts from [Proff.no](https://www.proff.no) and enter the start and end years from that table.

Then upload an Excel file in the set format.

Click 'Analyse' to analyse the data.

```{r sidebar}
# HTML
fileInput("html", label = "Upload html file", accept = ".html")

# Year inputs
numericInput("start", label = "Start", value = 2002)
numericInput("end", label = "End", value = 2021)

# Excel
fileInput("excel", "Upload Excel file", accept = ".xlsx")

# Button
actionButton("click", "Analyse")


```

Dashboard
=======================================================================

Row 
-----------------------------------------------------------------------

### KPI
```{r}
valueBoxOutput("KPI_box")
```

### KPI 2
```{r}
valueBoxOutput("KPI_box2")
```

### KPI 3
```{r}
valueBoxOutput("KPI_box3")
```

### KPI 4
```{r}
valueBoxOutput("KPI_box4")
```

### KPI 5
```{r}
valueBoxOutput("KPI_box5")
```

Row
-----------------------------------------------------------------------

### Plotly
```{r}
plotlyOutput("plotlyplot")
```

### Annual result
```{r}
plotlyOutput("arsresultat_plot")
```

Row 
-----------------------------------------------------------------------

### Transparency
```{r}
plotlyOutput("fancyplotly")
```

Details
=======================================================================

Row 
-----------------------------------------------------------------------

### Information 1

The KPIs are based on the following calculations:

- **admin** is based on dividing - expenses_administrative / expenses_program_services *100
- **Fundraising ROI** - (revenue_private_contributions +
                 revenue_membership_fees - expenses_fundraising) /
              expenses_fundraising * 100
```{r}

```

Row 
-----------------------------------------------------------------------

### Information 2
```{r}

```



```{r shiny, include=FALSE}
# Shiny actions
observeEvent(input$click, { # wait for button click

#---- Data frames --------------------------------------------------------------      
    # creating data frame from html file
    htmldata <- reactive({
      read_proff6(input$html$datapath,
                  as.character(input$start), as.character(input$end))
      })
    
    # Creating data frame from Excel file
    exceldata <- reactive({
      widen_excel(input$excel$datapath)
    })

#---- Value Boxes --------------------------------------------------------------    
    
    # Creating KPI_admin value
    KPI_admin <- reactive({
      exceldata() |> 
           mutate(
      KPI_admin =
        str_c( # Using str_c() to concatenate value and % sign
         format( # shortening(lengthening) the resulting value
           # calculating the value
          (expenses_administrative / expenses_program_services *100), digits = 3
          ), "%"
         )
      ) |> 
      filter(year == max(year)) |> # selecting latest available year
       select(KPI_admin) |> # dropping all other variables
        str_flatten() # turning into a single string
         })
    
    # Creating Fundraising ROI value
    KPI_fundraising_num <- reactive({
      exceldata() |> 
          mutate(
            # Calculating the value as a percentage
            KPI_fundraising_num =
              (revenue_private_contributions +
                 revenue_membership_fees - expenses_fundraising) /
              expenses_fundraising * 100) |> 
        # most recent year
          filter(year == max(year)) |> 
        # just want the single number
          select(KPI_fundraising_num) |> 
          pull()
    })
    
    # Creating the value box for administrative expenses
    output$KPI_box <- renderValueBox({
      valueBox(
        value = KPI_admin(),
        caption = "Admin spend",
        color = "primary",
        icon = "fa-random"
        )
      })
    
    # Creating value box for fundraising ROI
      # Unsure about colour levels
    output$KPI_box2 <- renderValueBox({
      valueBox(
        # shortening(lengthening) the value with format()
        # Using str_c() to concatenate value and % sign;
        value = str_c(format(KPI_fundraising_num(), digits = 3), "%"),
        caption = "Fundraising ROI",
        # Colour depends on value
        color = if (KPI_fundraising_num() < 100) {"danger"
          } else if (KPI_fundraising_num() < 200) {"warning"
            } else {"success"},
        icon = "fas fa-donate"
      )
    })
    
    # Duplicate value boxes for testing
    output$KPI_box3 <- renderValueBox({
      valueBox(
        value = str_c(format(KPI_fundraising_num(), digits = 3), "%"),
        caption = "success",
        color = "success",
        icon = "fas fa-coffee"
      )
    })
    
    output$KPI_box4 <- renderValueBox({
      valueBox(
        value = KPI_admin(),
        caption = "info",
        color = "info",
        icon = "fas fa-skull-crossbones"
    )})
      
    output$KPI_box5 <- renderValueBox({
      valueBox(
        value = KPI_admin(),
        caption = "warning",
        color = "warning",
        icon = "fas fa-battery-empty"
    )})
  
    
#---- Plots --------------------------------------------------------------------    
# creating plots - CEO compensation
    
    # ggplot as reactive function
    lonnplot <- reactive({
      ggplot(data = htmldata(), aes(year, lederlonn)) +
        geom_col() +
        scale_y_continuous(
          labels = scales::label_dollar(prefix = ""))
    })
    
    # Creating plotly plot
    output$plotlyplot <- renderPlotly(
      ggplotly(lonnplot())
    )
    
    # Creating ggplot
    output$htmlplot <- renderPlot(
      lonnplot()
    )
    
    # fancier plot function
    fancyplot <- reactive(
      htmldata() |> 
        select(
          year, lederlonn, leder_annen_godtgjorelse
         ) |> 
        mutate(
          lederlonn = lederlonn * 1000,
          leder_annen_godtgjorelse = leder_annen_godtgjorelse * 1000
        ) |> 
        # renaming for the purposes of the plot
        rename( 
          Year = year,
          Salary = lederlonn,
          `Other compensation` = leder_annen_godtgjorelse
        ) |> 
        # pivoting to join the two values to use fill
        pivot_longer(c(Salary, `Other compensation`), names_to = "Compensation") |> 
        ggplot(aes(Year, value, fill = Compensation)) +
        geom_col() +
        scale_y_continuous(
          # Checking for uniform currency code
        labels = ifelse(length(unique(htmldata()$valutakode)) == 1,
                        # Using the currency code if uniform
                    label_dollar(prefix = str_c(htmldata()$valutakode[1], " ")),
                        # alternative prefix if multiple currencies in the data
                    label_dollar(prefix = "? "))
         ) +
        # pretty colours
        scale_fill_met_d("Troy") + 
        labs(x = "Year", y = "Total compensation", title = "Annual CEO compensation",
             # Checking again for currency; including warning if not uniform
        subtitle = ifelse(length(unique(htmldata()$valutakode)) == 1,
                         "",
                         "Note: not all values are denominated in the same currency"))
        )
    
  # Creating fancy plotly output  
    output$fancyplotly <- renderPlotly(
      ggplotly(fancyplot())
    )
    
# Creating plots - annual result
    arsresultat_plot <- reactive({
      htmldata() |> 
      mutate(
        profit = ifelse(arsresultat >= 0, TRUE, FALSE)
      ) |> 
      ggplot(aes(year, arsresultat, fill = profit)) +
      geom_col() +
      scale_y_continuous(
        labels = ifelse(length(unique(htmldata()$valutakode)) == 1,
                        # Using the currency code if uniform
                    label_dollar(prefix = str_c(htmldata()$valutakode[1], " ")),
                        # alternative prefix if multiple currencies in the data
                    label_dollar(prefix = "? "))
        ) +
      scale_fill_met_d("Tsimshian") +
      theme(legend.position = "none") +
      labs(x = "Year", y = "", title = "Annual result (in thousands)",
             # Checking again for currency; including warning if not uniform
        subtitle = ifelse(length(unique(htmldata()$valutakode)) == 1,
                         "",
                         "Note: not all values are denominated in the same currency"))
    })
    
    output$arsresultat_plot <- renderPlotly(
      ggplotly(arsresultat_plot())
    )
    
    
})
```

```{r functions, include=FALSE}
# Function to read html file
read_proff6 <- function(file, start, end){
    read_html(file, encoding = "UTF-8") |> 
      html_node("#inner-frame") |> 
      html_table() |> 
      select( # removing empty column
        REGNSKAPSPERIODE:all_of(start)) |> # using all_of()
      mutate( # removing whitespace
        REGNSKAPSPERIODE = str_squish(REGNSKAPSPERIODE)
      ) |> 
      filter( # removing duplicate table - no idea why it's necessary
        !row_number() > 176
      ) |>
      filter( # removing duplicate rows
        !grepl("Lukk", REGNSKAPSPERIODE)
      ) |> 
      pivot_longer( # tidying data
        all_of(end):all_of(start), names_to = "year") |> # using all_of()
      mutate( # changing to real NAs and turning years into numbers
        value = na_if(value, "-"),
        year = as.integer(year)) |> 
      mutate( # adding currency column
        valutakode = ifelse(REGNSKAPSPERIODE == "Valutakode", value, NA)
      ) |> 
      fill( # filling the currency column
        valutakode, .direction = "updown"
      ) |> 
      filter( # removing dates and redundant currency
        REGNSKAPSPERIODE != "Sluttdato" & REGNSKAPSPERIODE != "Startdato" &
          REGNSKAPSPERIODE != "Valutakode") |> 
      mutate( # removing whitespace in numbers
        value = str_replace_all(value, "\\s", "")
      ) |> 
      mutate( # turning into numbers
        value = as.numeric(value)
      ) |> 
      mutate( # removing years as values
        value = ifelse(grepl("i hele 1000", REGNSKAPSPERIODE), NA, value)
      ) |> 
      distinct() |> # removing any remaining duplicate rows
      pivot_wider( # pivoting
        names_from = REGNSKAPSPERIODE, values_from = value
      ) |> 
      clean_names() |> # tidying names
      select(-lederlonn_i_hele_1000,
             -resultatregnskap_i_hele_1000,
             -balanseregnskap_i_hele_1000) |> # removing headings
      rename( # making it clear what lonn refers to
        lederlonn = lonn
      ) |> 
      arrange(desc(year)) # arranging by year
  }
  
# Function to read Excel file
widen_excel <- function(file){
    read_excel(file) |> 
      unite( # uniting Category and Name to deal with multiple 'Other'
        entry, c(Category, Name), sep = "_"
      ) |> 
      select(-`Sub-category`) |> # deleting Sub-category
    # pivoting
      pivot_wider(names_from = entry, values_from = Value) |> 
      clean_names() # cleaning names
}
```

