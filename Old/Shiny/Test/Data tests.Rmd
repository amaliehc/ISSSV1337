---
title: "Data tests"
author: "Torbj√∏rn Skinnemoen Ottersen"
date: "2022-07-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
library(pacman)
p_load(
  shiny, tidyverse, scales, rvest, janitor, plotly, readxl,
  flexdashboard, MetBrewer, fontawesome, htmltools
)
```

```{r}
library(tidyverse)
library(rvest)

read_html("Data/Kreftforeningen.html")
```

```{r}
read_proff <- function(file, start, end) {
  # Specifying encoding to deal with occasional errors
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table() |>
    # removing empty column, using all_of(argument)
    select(
      REGNSKAPSPERIODE:all_of(start)
    ) |>
    # removing white space
    mutate(
      REGNSKAPSPERIODE = str_squish(REGNSKAPSPERIODE)
    ) |>
    # removing duplicate table sometimes created by read_html()
    filter(
      !row_number() > 176
    ) |>
    # removing duplicate rows
    filter(
      !grepl("Lukk", REGNSKAPSPERIODE)
    ) |>
    # tidying data using pivot_longer() and all_of(argument)
    pivot_longer(
      all_of(end):all_of(start),
      names_to = "year"
    ) |>
    # creating a currency code column and turning current currency codes into
    # NAs
    mutate(
      # changing to real NAs
      value = na_if(value, "-"),
      # turning years into numbers
      year = as.integer(year),
      # creating a currency code column and turning current currency codes into
      # NAs
      valutakode = ifelse(REGNSKAPSPERIODE == "Valutakode", value, NA)
    ) |>
    # filling the currency column
    fill(
      valutakode,
      .direction = "updown"
    ) |>
    # removing dates and redundant currency
    filter(
      REGNSKAPSPERIODE != "Sluttdato" & REGNSKAPSPERIODE != "Startdato" &
        REGNSKAPSPERIODE != "Valutakode"
    ) |>
    mutate(
      # removing white space in numbers
      value = str_replace_all(value, "\\s", ""),
      # turning numbers into true numbers
      value = as.numeric(value),
      # removing values that are years
      value = ifelse(grepl("i hele 1000", REGNSKAPSPERIODE), NA, value)
    ) |>
    # removing any remaining duplicate rows
    distinct() |>
    # pivoting to create 'tidy' variables
    pivot_wider(
      names_from = REGNSKAPSPERIODE, values_from = value
    ) |>
    # tidying names
    clean_names() |>
    # removing headings from the table
    select(
      -lederlonn_i_hele_1000,
      -resultatregnskap_i_hele_1000,
      -balanseregnskap_i_hele_1000
    ) |>
    # making it clear what lonn refers to
    rename(
      lederlonn = lonn
    ) |>
    # Creating new variables for plots
    mutate(
      annual_profit = ifelse(arsresultat >= 0, TRUE, FALSE),
      balance_positive = ifelse(sum_egenkapital_og_gjeld >= 0, TRUE, FALSE)
    ) |>
    # arranging by year for practical display
    arrange(desc(year))
}
```

```{r}
getwd()
kreft <- read_proff("Data/Kreftforeningen.html", "2002", "2021")
```

```{r}
widen_excel <- function(file) {
  read_excel(file) |>
    # uniting Category and Name to deal with multiple 'Other'
    unite(
      entry, c(Category, Name),
      sep = "_"
    ) |>
    # deleting Sub-category and Firm
    select(-`Sub-category`, -Firm) |>
    # pivoting to create 'tidy' variables
    pivot_wider(names_from = entry, values_from = Value) |>
    # cleaning names
    clean_names()
}
```

```{r}
kreft_excel <- widen_excel("Data/OPXfinans_final.xlsx")
```

```{r}
excel_base <- read_excel("Data/OPXfinans_final.xlsx")

if (grepl("Category", names(excel_base))) {
  TRUE
}

?grepl

grepl("Category", names(excel_base))

if ("Category" %in% names(excel_base)) {
  TRUE
}

if ("2022" %in% names(kreft) && "2002" %in% names(kreft)) {
  TRUE
}
getwd()
blank <- read_excel("Data/Blank2.xlsx")

if ("Year" %in% names(blank) && "Category" %in% names(blank)) {
  TRUE
} else {
  FALSE
}

if ("Year" %in% names(excel_base) && "Category" %in% names(excel_base)) {
  TRUE
} else {
  FALSE
}

if ("Year" %in% names(excel_base)) {
  TRUE
} else {
  FALSE
}

?missing
```

```{r}
read_proff_test <- function(file) {
  # Specifying encoding to deal with occasional errors
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table()
}
    
read_proff_complete <- function(object, start, end) {
    if (as.character(all_of(start)) %in% names(object) && as.character(all_of(end)) %in% names(object)) {
    # removing empty column, using all_of(argument)
    object |> 
      select(
      REGNSKAPSPERIODE:all_of(start)
    ) |>
    # removing white space
    mutate(
      REGNSKAPSPERIODE = str_squish(REGNSKAPSPERIODE)
    ) |>
    # removing duplicate table sometimes created by read_html()
    filter(
      !row_number() > 176
    ) |>
    # removing duplicate rows
    filter(
      !grepl("Lukk", REGNSKAPSPERIODE)
    ) |>
    # tidying data using pivot_longer() and all_of(argument)
    pivot_longer(
      all_of(end):all_of(start),
      names_to = "year"
    ) |>
    # creating a currency code column and turning current currency codes into
    # NAs
    mutate(
      # changing to real NAs
      value = na_if(value, "-"),
      # turning years into numbers
      year = as.integer(year),
      # creating a currency code column and turning current currency codes into
      # NAs
      valutakode = ifelse(REGNSKAPSPERIODE == "Valutakode", value, NA)
    ) |>
    # filling the currency column
    fill(
      valutakode,
      .direction = "updown"
    ) |>
    # removing dates and redundant currency
    filter(
      REGNSKAPSPERIODE != "Sluttdato" & REGNSKAPSPERIODE != "Startdato" &
        REGNSKAPSPERIODE != "Valutakode"
    ) |>
    mutate(
      # removing white space in numbers
      value = str_replace_all(value, "\\s", ""),
      # turning numbers into true numbers
      value = as.numeric(value),
      # removing values that are years
      value = ifelse(grepl("i hele 1000", REGNSKAPSPERIODE), NA, value)
    ) |>
    # removing any remaining duplicate rows
    distinct() |>
    # pivoting to create 'tidy' variables
    pivot_wider(
      names_from = REGNSKAPSPERIODE, values_from = value
    ) |>
    # tidying names
    clean_names() |>
    # removing headings from the table
    select(
      -lederlonn_i_hele_1000,
      -resultatregnskap_i_hele_1000,
      -balanseregnskap_i_hele_1000
    ) |>
    # making it clear what lonn refers to
    rename(
      lederlonn = lonn
    ) |>
    # Creating new variables for plots
    mutate(
      annual_profit = ifelse(arsresultat >= 0, TRUE, FALSE),
      balance_positive = ifelse(sum_egenkapital_og_gjeld >= 0, TRUE, FALSE)
    ) |>
    # arranging by year for practical display
    arrange(desc(year))
    } else {
      message("Please ensure you have entered the correct start and end years")
    }
  }
```

```{r}
html_test <- read_proff_test("Data/Kreftforeningen.html")

html_test

testing <- read_proff_complete(html_test, "2002", "2021")

names(html_test)

testing
```
```{r}
?validate
```

```{r}
read_proff_names <- function(file, start, end) {
  # Specifying encoding to deal with occasional errors
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table() |>
    names()
}

read_proff_names("Data/Kreftforeningen.html", "2002")
```

