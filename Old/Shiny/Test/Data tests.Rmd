---
title: "Data tests"
author: "Torbj√∏rn Skinnemoen Ottersen"
date: "2022-07-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
library(pacman)
p_load(
  shiny, tidyverse, scales, rvest, janitor, plotly, readxl,
  flexdashboard, MetBrewer, fontawesome, htmltools
)
```

```{r}
library(tidyverse)
library(rvest)

read_html("Data/Kreftforeningen.html")
```

```{r}
read_proff <- function(file, start, end) {
  # Specifying encoding to deal with occasional errors
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table() |>
    # removing empty column, using all_of(argument)
    select(
      REGNSKAPSPERIODE:all_of(start)
    ) |>
    # removing white space
    mutate(
      REGNSKAPSPERIODE = str_squish(REGNSKAPSPERIODE)
    ) |>
    # removing duplicate table sometimes created by read_html()
    filter(
      !row_number() > 176
    ) |>
    # removing duplicate rows
    filter(
      !grepl("Lukk", REGNSKAPSPERIODE)
    ) |>
    # tidying data using pivot_longer() and all_of(argument)
    pivot_longer(
      all_of(end):all_of(start),
      names_to = "year"
    ) |>
    # creating a currency code column and turning current currency codes into
    # NAs
    mutate(
      # changing to real NAs
      value = na_if(value, "-"),
      # turning years into numbers
      year = as.integer(year),
      # creating a currency code column and turning current currency codes into
      # NAs
      valutakode = ifelse(REGNSKAPSPERIODE == "Valutakode", value, NA)
    ) |>
    # filling the currency column
    fill(
      valutakode,
      .direction = "updown"
    ) |>
    # removing dates and redundant currency
    filter(
      REGNSKAPSPERIODE != "Sluttdato" & REGNSKAPSPERIODE != "Startdato" &
        REGNSKAPSPERIODE != "Valutakode"
    ) |>
    mutate(
      # removing white space in numbers
      value = str_replace_all(value, "\\s", ""),
      # turning numbers into true numbers
      value = as.numeric(value),
      # removing values that are years
      value = ifelse(grepl("i hele 1000", REGNSKAPSPERIODE), NA, value)
    ) |>
    # removing any remaining duplicate rows
    distinct() |>
    # pivoting to create 'tidy' variables
    pivot_wider(
      names_from = REGNSKAPSPERIODE, values_from = value
    ) |>
    # tidying names
    clean_names() |>
    # removing headings from the table
    select(
      -lederlonn_i_hele_1000,
      -resultatregnskap_i_hele_1000,
      -balanseregnskap_i_hele_1000
    ) |>
    # making it clear what lonn refers to
    rename(
      lederlonn = lonn
    ) |>
    # Creating new variables for plots
    mutate(
      annual_profit = ifelse(arsresultat >= 0, TRUE, FALSE),
      balance_positive = ifelse(sum_egenkapital_og_gjeld >= 0, TRUE, FALSE)
    ) |>
    # arranging by year for practical display
    arrange(desc(year))
}
```

```{r}
getwd()
kreft <- read_proff("Data/Kreftforeningen.html", "2002", "2021")
```

```{r}
widen_excel <- function(file) {
  read_excel(file) |>
    # uniting Category and Name to deal with multiple 'Other'
    unite(
      entry, c(Category, Name),
      sep = "_"
    ) |>
    # deleting Sub-category and Firm
    select(-`Sub-category`, -Firm) |>
    # pivoting to create 'tidy' variables
    pivot_wider(names_from = entry, values_from = Value) |>
    # cleaning names
    clean_names()
}
```

```{r}
kreft_excel <- widen_excel("Data/OPXfinans_final.xlsx")
```

```{r}
excel_base <- read_excel("Data/OPXfinans_final.xlsx")

if (grepl("Category", names(excel_base))) {
  TRUE
}

?grepl

grepl("Category", names(excel_base))

if ("Category" %in% names(excel_base)) {
  TRUE
}

if ("2022" %in% names(kreft) && "2002" %in% names(kreft)) {
  TRUE
}
getwd()
blank <- read_excel("Data/Blank2.xlsx")

if ("Year" %in% names(blank) && "Category" %in% names(blank)) {
  TRUE
} else {
  FALSE
}

if ("Year" %in% names(excel_base) && "Category" %in% names(excel_base)) {
  TRUE
} else {
  FALSE
}

if ("Year" %in% names(excel_base)) {
  TRUE
} else {
  FALSE
}

names(excel_base)


excel_base$`Sub-category`

excel_tested <- read_excel("Data/Blank2.xlsx") |> 
  clean_names()

widen_excel_testing <- function(object) {
  if ("Year" %in% names(object) && "Firm" %in% names(object) &&
    "Category" %in% names(object) && "'Sub-category'" %in% names(object) &&
    "Name" %in% names(object) && "Value" %in% names(object)) {
    object |>
      # uniting Category and Name to deal with multiple 'Other'
      unite(
        entry, c(Category, Name),
        sep = "_"
      ) |>
      # deleting Sub-category and Firm
      select(-`Sub-category`, -Firm) |>
      # pivoting to create 'tidy' variables
      pivot_wider(names_from = entry, values_from = Value) |>
      # cleaning names
      clean_names()
  } else {
    message("Bad")
  }
}

getwd()

widen_excel_testing(excel_base)

exceltest |> clean_names()
getwd()
blank <- read_excel("Data/Blank2.xlsx")
names(blank)

clean_names(blank)

getwd()
excel_logic <- read_excel("Data/OPXfinans_final.xlsx") |> clean_names()

excel_logic

excel_names <- names(excel_logic)

excel_names == c("year", "firm", "category", "sub_category", "name", "value")

class(excel_names)

if (excel_names == c("year", "firm", "category", "sub_category", "name", "value")) {
  "yes"
} else {
  "no"
}

setequal(excel_names, c("year", "firm", "category", "sub_category", "name", "value"))
```

```{r}
read_proff_test <- function(file) {
  # Specifying encoding to deal with occasional errors
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table()
}
    
read_proff_complete <- function(object, start, end) {
    if (as.character(all_of(start)) %in% names(object) && as.character(all_of(end)) %in% names(object)) {
    # removing empty column, using all_of(argument)
    object |> 
      select(
      REGNSKAPSPERIODE:all_of(start)
    ) |>
    # removing white space
    mutate(
      REGNSKAPSPERIODE = str_squish(REGNSKAPSPERIODE)
    ) |>
    # removing duplicate table sometimes created by read_html()
    filter(
      !row_number() > 176
    ) |>
    # removing duplicate rows
    filter(
      !grepl("Lukk", REGNSKAPSPERIODE)
    ) |>
    # tidying data using pivot_longer() and all_of(argument)
    pivot_longer(
      all_of(end):all_of(start),
      names_to = "year"
    ) |>
    # creating a currency code column and turning current currency codes into
    # NAs
    mutate(
      # changing to real NAs
      value = na_if(value, "-"),
      # turning years into numbers
      year = as.integer(year),
      # creating a currency code column and turning current currency codes into
      # NAs
      valutakode = ifelse(REGNSKAPSPERIODE == "Valutakode", value, NA)
    ) |>
    # filling the currency column
    fill(
      valutakode,
      .direction = "updown"
    ) |>
    # removing dates and redundant currency
    filter(
      REGNSKAPSPERIODE != "Sluttdato" & REGNSKAPSPERIODE != "Startdato" &
        REGNSKAPSPERIODE != "Valutakode"
    ) |>
    mutate(
      # removing white space in numbers
      value = str_replace_all(value, "\\s", ""),
      # turning numbers into true numbers
      value = as.numeric(value),
      # removing values that are years
      value = ifelse(grepl("i hele 1000", REGNSKAPSPERIODE), NA, value)
    ) |>
    # removing any remaining duplicate rows
    distinct() |>
    # pivoting to create 'tidy' variables
    pivot_wider(
      names_from = REGNSKAPSPERIODE, values_from = value
    ) |>
    # tidying names
    clean_names() |>
    # removing headings from the table
    select(
      -lederlonn_i_hele_1000,
      -resultatregnskap_i_hele_1000,
      -balanseregnskap_i_hele_1000
    ) |>
    # making it clear what lonn refers to
    rename(
      lederlonn = lonn
    ) |>
    # Creating new variables for plots
    mutate(
      annual_profit = ifelse(arsresultat >= 0, TRUE, FALSE),
      balance_positive = ifelse(sum_egenkapital_og_gjeld >= 0, TRUE, FALSE)
    ) |>
    # arranging by year for practical display
    arrange(desc(year))
    } else {
      message("Please ensure you have entered the correct start and end years")
    }
  }
```

```{r}
html_test <- read_proff_test("Data/Kreftforeningen.html")

html_test

testing <- read_proff_complete(html_test, "2002", "2021")

names(html_test)

testing
```
```{r}
?validate
```

```{r}
read_proff_names <- function(file, start, end) {
  # Specifying encoding to deal with occasional errors
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table() |>
    names()
}

read_proff_names("Data/Kreftforeningen.html", "2002")

nrk <- read_html("Data/NRK.html")
nrk_node <- nrk |> html_node("#inner-frame")

class(nrk_node)

wrong <- read_html("Data/Kreft_wrong.html") |> html_node("#inner-frame") |> html_table()

wrong



right <- read_html("Data/Kreftforeningen.html", encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table()

right

"REGNSKAPSPERIODE" %in% names(wrong)

if (class(nrk_node) == "xml_missing") {
  TRUE
} else {
  FALSE
}

read_proff_read <- function(file) {
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame")
}

testing <- read_html("Data/Kreftforeningen.html", encoding = "UTF-8") |>
    html_node("#inner-frame")

class(testing)

read_proff_table <- function(object) {
  html_table()
}

empty <- read_proff_read("Data/Kreft_wrong.html") |> html_table()

"REGNSKAPSPERIODE" %in% names(empty)


read_proff_testing(testing, "2002", "2021")

htmldata <- function(file, start, end) {
  node <- read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame")
  
  if (class(node) == "xml_node") {
    table <- node |> html_table()
  } else {
    message("Table error.")
  }
  
  if ("REGNSKAPSPERIODE" %in% names(table)) {
    if (as.character(all_of(start)) %in% names(table) &&
    as.character(all_of(end)) %in% names(table)) {
      read_proff_notest("Data/Kreftforeningen.html", start, end)
    } else {
      message("character error")
    }
  } else {
    message("Regnskap error.")
  }
}

htmldata("Data/Kreftforeningen.html", "2002", "2021")

weird <- read_html("Data/Kreftforeningen.html", encoding = "UTF-8") |> 
  html_element("#inner-frame") |> html_table()

names(weird)

"2002" %in% names(weird)


read_test <- function(object, start, end) {
  if (as.character(all_of(start)) %in% names(object) &&
    as.character(all_of(end)) %in% names(object)) {
    TRUE
  } else {
    FALSE
  }
}


html_first_test <- function(file) {
  
  htmltest <- read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame")

  if (class(htmltest) == "xml_node") {
    htmltable <- htmltest |> html_table()
  } else {
    "table error"
  }

  if ("REGNSKAPSPERIODE" %in% names(htmltable)) {
    htmlready <- htmltable
  } else {
    "regnskap error"
  }
}

html_first_test("Data/Kreftforeningen.html")

html_second_test <- function(object, start, end) {
  if (as.character(all_of(start)) %in% names(object) &&
    as.character(all_of(end)) %in% names(object)) {
    read_proff_notest(object, start, end)
  } else {
    FALSE
  }
}

html_second_test(htmlready, "2002", "2021")

read_test(weird, "2002", "2021")

html_testing <- function(file, start, end) {
  
  htmltest <- read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame")

  if (class(htmltest) == "xml_node") {
    htmltable <- htmltest |> html_table()
  } else {
    "table error"
  }

  if ("REGNSKAPSPERIODE" %in% names(htmltable)) {
    htmlready <- htmltable
  } else {
    "regnskap error"
  }
  
  if (as.character(all_of(start)) %in% names(htmlready) &&
    as.character(all_of(end)) %in% names(htmlready)) {
    read_proff_notest(file, start, end)
  } else {
    "year error"
  }
}

html_testing("Data/Kreftforeningen.html", "2002", "2021")

check

if (check == TRUE) {
  read_proff_notest("Data/Kreftforeningen.html", "2002", "2021")
} else {
  "what's wrong"
}
```

- test if html
- test if node is present
- test if correct table
- go for it



```{r}
read_proff_test <- function(file) {
  # Specifying encoding to deal with occasional errors
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table()
}

# Part 2 - version with integrated test
read_proff_complete <- function(object, start, end) {
  if (as.character(all_of(start)) %in% names(object) &&
    as.character(all_of(end)) %in% names(object)) {
    object |>
      # removing empty column, using all_of(argument)
      select(
        REGNSKAPSPERIODE:all_of(start)
      ) |>
      # removing white space
      mutate(
        REGNSKAPSPERIODE = str_squish(REGNSKAPSPERIODE)
      ) |>
      # removing duplicate table sometimes created by read_html()
      filter(
        !row_number() > 176
      ) |>
      # removing duplicate rows
      filter(
        !grepl("Lukk", REGNSKAPSPERIODE)
      ) |>
      # tidying data using pivot_longer() and all_of(argument)
      pivot_longer(
        all_of(end):all_of(start),
        names_to = "year"
      ) |>
      # creating a currency code column and turning current currency codes into
      # NAs
      mutate(
        # changing to real NAs
        value = na_if(value, "-"),
        # turning years into numbers
        year = as.integer(year),
        # creating a currency code column and turning current currency codes into
        # NAs
        valutakode = ifelse(REGNSKAPSPERIODE == "Valutakode", value, NA)
      ) |>
      # filling the currency column
      fill(
        valutakode,
        .direction = "updown"
      ) |>
      # removing dates and redundant currency
      filter(
        REGNSKAPSPERIODE != "Sluttdato" & REGNSKAPSPERIODE != "Startdato" &
          REGNSKAPSPERIODE != "Valutakode"
      ) |>
      mutate(
        # removing white space in numbers
        value = str_replace_all(value, "\\s", ""),
        # turning numbers into true numbers
        value = as.numeric(value),
        # removing values that are years
        value = ifelse(grepl("i hele 1000", REGNSKAPSPERIODE), NA, value)
      ) |>
      # removing any remaining duplicate rows
      distinct() |>
      # pivoting to create 'tidy' variables
      pivot_wider(
        names_from = REGNSKAPSPERIODE, values_from = value
      ) |>
      # tidying names
      clean_names() |>
      # removing headings from the table
      select(
        -lederlonn_i_hele_1000,
        -resultatregnskap_i_hele_1000,
        -balanseregnskap_i_hele_1000
      ) |>
      # making it clear what lonn refers to
      rename(
        lederlonn = lonn
      ) |>
      # Creating new variables for plots
      mutate(
        annual_profit = ifelse(arsresultat >= 0, TRUE, FALSE),
        balance_positive = ifelse(sum_egenkapital_og_gjeld >= 0, TRUE, FALSE)
      ) |>
      # arranging by year for practical display
      arrange(desc(year))
  } else {
    validate("Please ensure you have entered the correct start and end years")
  }
}

read_proff_notest <- function(file, start, end) {
  read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame") |>
    html_table() |> 
      # removing empty column, using all_of(argument)
      select(
        REGNSKAPSPERIODE:all_of(start)
      ) |>
      # removing white space
      mutate(
        REGNSKAPSPERIODE = str_squish(REGNSKAPSPERIODE)
      ) |>
      # removing duplicate table sometimes created by read_html()
      filter(
        !row_number() > 176
      ) |>
      # removing duplicate rows
      filter(
        !grepl("Lukk", REGNSKAPSPERIODE)
      ) |>
      # tidying data using pivot_longer() and all_of(argument)
      pivot_longer(
        all_of(end):all_of(start),
        names_to = "year"
      ) |>
      # creating a currency code column and turning current currency codes into
      # NAs
      mutate(
        # changing to real NAs
        value = na_if(value, "-"),
        # turning years into numbers
        year = as.integer(year),
        # creating a currency code column and turning current currency codes into
        # NAs
        valutakode = ifelse(REGNSKAPSPERIODE == "Valutakode", value, NA)
      ) |>
      # filling the currency column
      fill(
        valutakode,
        .direction = "updown"
      ) |>
      # removing dates and redundant currency
      filter(
        REGNSKAPSPERIODE != "Sluttdato" & REGNSKAPSPERIODE != "Startdato" &
          REGNSKAPSPERIODE != "Valutakode"
      ) |>
      mutate(
        # removing white space in numbers
        value = str_replace_all(value, "\\s", ""),
        # turning numbers into true numbers
        value = as.numeric(value),
        # removing values that are years
        value = ifelse(grepl("i hele 1000", REGNSKAPSPERIODE), NA, value)
      ) |>
      # removing any remaining duplicate rows
      distinct() |>
      # pivoting to create 'tidy' variables
      pivot_wider(
        names_from = REGNSKAPSPERIODE, values_from = value
      ) |>
      # tidying names
      clean_names() |>
      # removing headings from the table
      select(
        -lederlonn_i_hele_1000,
        -resultatregnskap_i_hele_1000,
        -balanseregnskap_i_hele_1000
      ) |>
      # making it clear what lonn refers to
      rename(
        lederlonn = lonn
      ) |>
      # Creating new variables for plots
      mutate(
        annual_profit = ifelse(arsresultat >= 0, TRUE, FALSE),
        balance_positive = ifelse(sum_egenkapital_og_gjeld >= 0, TRUE, FALSE)
      ) |>
      # arranging by year for practical display
      arrange(desc(year))
}
```

```{r}
# This may be the function =====================================================

html_testing <- function(file, start, end) {
  
  htmltest <- read_html(file, encoding = "UTF-8") |>
    html_node("#inner-frame")

  if (class(htmltest) == "xml_node") {
    htmltable <- htmltest |> html_table()
  } else {
    "table error"
  }

  if ("REGNSKAPSPERIODE" %in% names(htmltable)) {
    htmlready <- htmltable
  } else {
    "regnskap error"
  }
  
  if (as.character(all_of(start)) %in% names(htmlready) &&
    as.character(all_of(end)) %in% names(htmlready)) {
    read_proff_notest(file, start, end)
  } else {
    "year error"
  }
}
```



